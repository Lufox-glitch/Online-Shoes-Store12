<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - P&S Online Shoes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f8f8;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            background: #000;
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 40px;
            border-radius: 0;
        }

        header h1 {
            font-size: 28px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #000;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #000;
            color: white;
            border-radius: 50%;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #000;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select,
        textarea {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .radio-option:hover {
            border-color: #000;
            background: #f9f9f9;
        }

        .radio-option input[type="radio"]:checked + label,
        .radio-option input[type="radio"]:checked ~ .option-content {
            color: #000;
            font-weight: 600;
        }

        .option-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .option-label {
            font-weight: 600;
            color: #000;
        }

        .option-desc {
            font-size: 12px;
            color: #666;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            border: 2px dashed #999;
            border-radius: 6px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background: #f0f0f0;
            border-color: #000;
        }

        .file-preview {
            margin-top: 12px;
            max-width: 150px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .cart-summary {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
            border: 1px solid #e0e0e0;
        }

        .cart-summary h3 {
            font-size: 20px;
            font-weight: 700;
            color: #000;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item-name {
            font-weight: 600;
            color: #000;
        }

        .item-qty {
            font-size: 12px;
            color: #666;
        }

        .item-price {
            font-weight: 700;
            color: #000;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #000;
            border-radius: 6px;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin: 20px 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }

        .summary-row.total {
            font-size: 16px;
            font-weight: 700;
            color: #000;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #000;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .message.success {
            background: #f0f0f0;
            color: #000;
            border: 1px solid #999;
            display: block;
        }

        .message.error {
            background: #f8f8f8;
            color: #000;
            border: 1px solid #fca5a5;
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 900px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }

            .cart-summary {
                position: relative;
                top: auto;
            }
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            header {
                padding: 15px 20px;
            }

            header h1 {
                font-size: 20px;
            }

            .section {
                padding: 20px;
            }
        }

        .step-indicator {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: space-between;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
            text-align: center;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin: 0 auto;
        }

        .step.active .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .step-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
        }

        .step.active .step-label {
            color: #667eea;
        }
    </style>
</head>
<body>
    <header>
        <h1>üõí Checkout</h1>
    </header>

    <div class="container">
        <div class="step-indicator">
            <div class="step active">
                <div class="step-number">1</div>
                <div class="step-label">Shipping</div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-label">Delivery</div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-label">Payment</div>
            </div>
        </div>

        <div class="checkout-grid">
            <div>
                <!-- Shipping Section -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-number">1</div>
                        Shipping Address
                    </div>
                    <div id="shippingMessage"></div>
                    <form id="shippingForm">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="fullName" required placeholder="Enter your full name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="email" required placeholder="your@email.com">
                            </div>
                            <div class="form-group">
                                <label>Phone *</label>
                                <input type="tel" id="phone" required placeholder="Your phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Street Address *</label>
                            <input type="text" id="streetAddress" required placeholder="123 Main Street">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City *</label>
                                <input type="text" id="city" required placeholder="City name">
                            </div>
                            <div class="form-group">
                                <label>Postal Code *</label>
                                <input type="text" id="postalCode" required placeholder="Postal code">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Delivery Section -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-number">2</div>
                        Delivery Options
                    </div>
                    <div id="deliveryMessage"></div>
                    <div class="form-group">
                        <label>Preferred Delivery Date *</label>
                        <input type="date" id="deliveryDate" required min="">
                    </div>
                    <div class="form-group">
                        <label>Delivery Type</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="standard" name="deliveryType" value="standard" checked>
                                <div class="option-content">
                                    <div class="option-label">Standard Delivery</div>
                                    <div class="option-desc">5-7 business days - Free</div>
                                </div>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="express" name="deliveryType" value="express">
                                <div class="option-content">
                                    <div class="option-label">Express Delivery</div>
                                    <div class="option-desc">2-3 business days - +‚Ç®500</div>
                                </div>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="overnight" name="deliveryType" value="overnight">
                                <div class="option-content">
                                    <div class="option-label">Overnight Delivery</div>
                                    <div class="option-desc">Next business day - +‚Ç®1,500</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Special Instructions (Optional)</label>
                        <textarea id="deliveryNotes" placeholder="e.g., Leave at front door, use side entrance, etc."></textarea>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="section">
                    <div class="section-title">
                        <div class="section-number">3</div>
                        Payment Method
                    </div>
                    <div class="form-group">
                        <label>Select Payment Method *</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="esewa" name="paymentMethod" value="esewa" checked>
                                <div class="option-content">
                                    <div class="option-label">eSewa</div>
                                    <div class="option-desc">Secure payment via eSewa wallet</div>
                                </div>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="khalti" name="paymentMethod" value="khalti">
                                <div class="option-content">
                                    <div class="option-label">Khalti</div>
                                    <div class="option-desc">Fast payment via Khalti app</div>
                                </div>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="mobileBanking" name="paymentMethod" value="mobile-banking">
                                <div class="option-content">
                                    <div class="option-label">Mobile Banking</div>
                                    <div class="option-desc">Via your bank's mobile app</div>
                                </div>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="cashOnDelivery" name="paymentMethod" value="cash-on-delivery">
                                <div class="option-content">
                                    <div class="option-label">Cash on Delivery</div>
                                    <div class="option-desc">Pay when your order is delivered</div>
                                </div>
                            </div>

                    <div class="form-group" id="transactionIdGroup">
                        <label>Transaction ID (from payment app) *</label>
                        <input type="text" id="transactionId" required placeholder="Enter transaction ID">
                    </div>

                    <div class="form-group" id="screenshotGroup">
                        <label>Payment Screenshot *</label>
                        <div class="file-upload">
                            <input type="file" id="paymentScreenshot" accept="image/*" required>
                            <label for="paymentScreenshot" class="file-upload-label">
                                <span>üì∏ Click to upload payment screenshot</span>
                            </label>
                            <img id="preview" class="file-preview" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message Display -->
            <div id="checkoutErrorContainer" style="display: none; margin-bottom: 20px; padding: 15px; border-radius: 8px; background: #fee; border-left: 4px solid #f44;">
                <div style="color: #c33; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Error</div>
                <div id="checkoutErrorMessage" style="color: #c33; font-size: 14px;"></div>
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary">
                <h3>Order Summary</h3>
                <div id="cartItems"></div>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">‚Ç®0</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Charge:</span>
                    <span id="deliveryCharge">‚Ç®0</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="total">‚Ç®0</span>
                </div>
                <button class="btn btn-primary" id="placeOrderBtn" onclick="placeOrder()">Place Order</button>
            </div>
        </div>
    </div>

    <script>
        // Set minimum date to today
        const today = new Date();
        today.setDate(today.getDate() + 1);
        const minDate = today.toISOString().split('T')[0];
        document.getElementById('deliveryDate').min = minDate;
        document.getElementById('deliveryDate').value = minDate;

        // File upload preview
        document.getElementById('paymentScreenshot').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Update delivery charge based on selected option
        document.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
            radio.addEventListener('change', updateTotal);
        });

        function updateTotal() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            let subtotal = 0;
            
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            let deliveryCharge = 0;
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
            if (deliveryType === 'express') {
                deliveryCharge = 500;
            } else if (deliveryType === 'overnight') {
                deliveryCharge = 1500;
            }

            const total = subtotal + deliveryCharge;

            document.getElementById('subtotal').textContent = '‚Ç®' + subtotal.toLocaleString();
            document.getElementById('deliveryCharge').textContent = '‚Ç®' + deliveryCharge.toLocaleString();
            document.getElementById('total').textContent = '‚Ç®' + total.toLocaleString();
        }

        // Load cart items
        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const cartItemsDiv = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">Your cart is empty</div>';
                return;
            }

            cartItemsDiv.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-qty">Qty: ${item.quantity}</div>
                    </div>
                    <div class="item-price">‚Ç®${(item.price * item.quantity).toLocaleString()}</div>
                </div>
            `).join('');

            updateTotal();
        }

        // Load user info if logged in
        function loadUserInfo() {
            // Clean up old/stale storage formats
            localStorage.removeItem('user');
            
            // Priority: sessionStorage (current session) over localStorage (persistent)
            let user = null;
            
            // First try sessionStorage (takes precedence - most recent login)
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                try {
                    user = JSON.parse(sessionUser);
                } catch (e) {
                    console.error('Error parsing sessionStorage user:', e);
                    sessionStorage.removeItem('currentUser');
                }
            }
            
            // Fall back to localStorage if no sessionStorage data
            if (!user) {
                const localUser = localStorage.getItem('currentUser');
                if (localUser) {
                    try {
                        user = JSON.parse(localUser);
                    } catch (e) {
                        console.error('Error parsing localStorage user:', e);
                        localStorage.removeItem('currentUser');
                    }
                }
            }
            
            if (user && user.email && user.first_name) {
                document.getElementById('email').value = user.email;
                const nameparts = (user.first_name || '') + ' ' + (user.last_name || '');
                document.getElementById('fullName').value = nameparts.trim();
            }
        }

        // Show message
        function showMessage(elementId, message, type) {
            // Display error/success in the checkout error container above order summary
            if (type === 'error') {
                document.getElementById('checkoutErrorMessage').textContent = message;
                document.getElementById('checkoutErrorContainer').style.display = 'block';
            } else if (type === 'success') {
                document.getElementById('checkoutErrorContainer').style.display = 'none';
            }
            
            // Auto-hide errors after 5 seconds
            if (type === 'error') {
                setTimeout(() => {
                    document.getElementById('checkoutErrorContainer').style.display = 'none';
                }, 5000);
            }
        }

        // Place order
        async function placeOrder() {
            // Validate form
            const shipping = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                streetAddress: document.getElementById('streetAddress').value,
                city: document.getElementById('city').value,
                postalCode: document.getElementById('postalCode').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                deliveryType: document.querySelector('input[name="deliveryType"]:checked').value,
                deliveryNotes: document.getElementById('deliveryNotes').value,
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                transactionId: document.getElementById('transactionId').value
            };

            // Validate required fields
            if (!shipping.fullName || !shipping.email || !shipping.phone || !shipping.streetAddress || 
                !shipping.city || !shipping.postalCode || !shipping.deliveryDate) {
                showMessage('paymentMessage', 'Please fill all required fields', 'error');
                return;
            }

            // Declare screenshotFile here so it's available throughout the function
            let screenshotFile = null;

            // For non-COD methods, require transaction ID and screenshot
            if (shipping.paymentMethod !== 'cash-on-delivery') {
                if (!shipping.transactionId) {
                    showMessage('paymentMessage', 'Please enter transaction ID', 'error');
                    return;
                }

                screenshotFile = document.getElementById('paymentScreenshot').files[0];
                if (!screenshotFile) {
                    showMessage('paymentMessage', 'Please upload payment screenshot', 'error');
                    return;
                }
            }

            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                showMessage('paymentMessage', 'Your cart is empty', 'error');
                return;
            }

            try {
                const btn = document.getElementById('placeOrderBtn');
                btn.disabled = true;
                btn.textContent = 'Processing...';

                // Step 1: Create order
                const cart_total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let deliveryCharge = 0;
                if (shipping.deliveryType === 'express') {
                    deliveryCharge = 500;
                } else if (shipping.deliveryType === 'overnight') {
                    deliveryCharge = 1500;
                }
                const total = cart_total + deliveryCharge;

                const orderPayload = {
                    items: cart.map(item => ({
                        product_id: item.id,
                        quantity: item.quantity,
                        price: item.price,
                        size: item.size || null
                    })),
                    total_amount: total,
                    payment_method: shipping.paymentMethod,
                    shipping_address: `${shipping.streetAddress}, ${shipping.city}, ${shipping.postalCode}`
                };

                console.log('=== ORDER PAYLOAD DEBUG ===');
                console.log('Order Payload:', orderPayload);
                console.log('Payment Method:', shipping.paymentMethod);
                console.log('Shipping Data:', {
                    fullName: shipping.fullName,
                    email: shipping.email,
                    phone: shipping.phone,
                    streetAddress: shipping.streetAddress,
                    city: shipping.city,
                    postalCode: shipping.postalCode,
                    deliveryDate: shipping.deliveryDate,
                    deliveryType: shipping.deliveryType
                });
                console.log('=== END DEBUG ===');

                const orderResponse = await fetch('/Online-Shoes-Store/Backend/api/orders.php?request=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(orderPayload)
                });

                const orderData = await orderResponse.json();
                console.log('Order Response:', orderData);
                if (!orderData.success) {
                    console.error('Order Error Details:', orderData);
                    let errorMsg = 'Failed to create order';
                    
                    // If errors object exists, format it nicely
                    if (orderData.errors && typeof orderData.errors === 'object') {
                        const errorLines = Object.entries(orderData.errors).map(([key, value]) => `${key}: ${value}`);
                        errorMsg = errorLines.join('\n');
                    } else if (orderData.message) {
                        errorMsg = orderData.message;
                    }
                    
                    console.error('Formatted Error:', errorMsg);
                    throw new Error(errorMsg);
                }

                const orderId = orderData.data.id;
                console.log('Order ID:', orderId);
                
                if (!orderId) {
                    throw new Error('Order ID not returned from server');
                }

                // Step 2: Create delivery record
                const deliveryPayload = {
                    order_id: orderId,
                    estimated_delivery_date: shipping.deliveryDate,
                    delivery_address: `${shipping.streetAddress}, ${shipping.city}, ${shipping.postalCode}`
                };
                
                const deliveryResponse = await fetch('/Online-Shoes-Store/Backend/api/delivery.php?request=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(deliveryPayload)
                });

                const deliveryData = await deliveryResponse.json();
                console.log('Delivery Response:', deliveryData);
                if (!deliveryData.success) {
                    const errorMsg = deliveryData.errors ? JSON.stringify(deliveryData.errors) : (deliveryData.message || 'Failed to create delivery record');
                    throw new Error(errorMsg);
                }

                // Step 3: Upload payment with screenshot
                const formData = new FormData();
                formData.append('order_id', orderId);
                formData.append('payment_method', shipping.paymentMethod);
                formData.append('amount', total);
                
                // Only add screenshot for non-COD methods
                if (shipping.paymentMethod !== 'cash-on-delivery' && screenshotFile) {
                    formData.append('payment_screenshot', screenshotFile);
                }

                const paymentResponse = await fetch('/Online-Shoes-Store/Backend/api/payments.php?request=create', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const paymentData = await paymentResponse.json();
                console.log('Payment Response:', paymentData);
                if (!paymentData.success) {
                    const errorMsg = paymentData.errors ? JSON.stringify(paymentData.errors) : (paymentData.message || 'Failed to process payment');
                    throw new Error(errorMsg);
                }

                // Clear cart and show success
                localStorage.removeItem('cart');
                showMessage('paymentMessage', 'Order placed successfully! Redirecting...', 'success');

                // Store order info
                localStorage.setItem('lastOrder', JSON.stringify({
                    orderId: orderId,
                    total: total,
                    paymentMethod: shipping.paymentMethod,
                    deliveryDate: shipping.deliveryDate
                }));

                setTimeout(() => {
                    window.location.href = '/Online-Shoes-Store/Front-End/order-confirmation.html?orderId=' + orderId;
                }, 2000);

            } catch (error) {
                console.error('Checkout Error:', error);
                const btn = document.getElementById('placeOrderBtn');
                showMessage('paymentMessage', 'Error: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Place Order';
            }
        }

        // Toggle payment fields based on selected method
        function togglePaymentFields() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const transactionIdGroup = document.getElementById('transactionIdGroup');
            const screenshotGroup = document.getElementById('screenshotGroup');
            
            // For Cash on Delivery, hide transaction ID and screenshot fields
            if (paymentMethod === 'cash-on-delivery') {
                transactionIdGroup.style.display = 'none';
                screenshotGroup.style.display = 'none';
                // Remove required attribute
                document.getElementById('transactionId').removeAttribute('required');
                document.getElementById('paymentScreenshot').removeAttribute('required');
            } else {
                // For other methods, show transaction ID and screenshot fields
                transactionIdGroup.style.display = 'block';
                screenshotGroup.style.display = 'block';
                // Add required attribute
                document.getElementById('transactionId').setAttribute('required', '');
                document.getElementById('paymentScreenshot').setAttribute('required', '');
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Validate user session is still active before loading checkout
            validateAndLoadUserInfo();
            loadCart();
            
            // Set up payment method change handler
            const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');
            paymentMethodRadios.forEach(radio => {
                radio.addEventListener('change', togglePaymentFields);
            });
            
            // Initialize payment fields visibility
            togglePaymentFields();
        });
        
        // Validate user session with backend
        async function validateAndLoadUserInfo() {
            try {
                // Verify session is still active
                const sessionResponse = await fetch('/Online-Shoes-Store/Backend/api/auth.php?request=profile', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (sessionResponse.ok) {
                    const sessionData = await sessionResponse.json();
                    if (sessionData.success && sessionData.data) {
                        // Session is valid, update localStorage with fresh data
                        const freshUser = {
                            id: sessionData.data.id,
                            email: sessionData.data.email,
                            first_name: sessionData.data.first_name,
                            last_name: sessionData.data.last_name,
                            role: sessionData.data.role
                        };
                        
                        // Update both storage locations
                        sessionStorage.setItem('currentUser', JSON.stringify(freshUser));
                        localStorage.setItem('currentUser', JSON.stringify(freshUser));
                    }
                }
            } catch (error) {
                console.log('Session validation skipped');
            }
            
            loadUserInfo();
        }
    </script>
</body>
</html>
